<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quynj Translate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            500: '#8b5cf6', // Violet-500
                            600: '#7c3aed', // Violet-600
                            700: '#6d28d9',
                        },
                        surface: '#f8fafc',
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(124, 58, 237, 0.3)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            width: 100%;
            height: 100vh;
            background-color: #f1f5f9;
            display: flex;
            justify-content: center;
            align-items: center; /* Center for preview */
        }
        
        .app-container {
            width: 380px;
            height: 580px;
            background: #ffffff;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 20px; /* Softer corners */
            box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.1);
        }

        /* Hide scrollbar for cleaner look */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #7c3aed;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 2px 6px rgba(124, 58, 237, 0.4);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #ede9fe;
            border-radius: 2px;
        }

        /* Animations */
        .fade-in-up {
            animation: fadeInUp 0.4s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loader-dots div {
            animation-timing-function: cubic-bezier(0, 1, 1, 0);
        }
        .loader-dots div:nth-child(1) { left: 8px; animation: loader-dots1 0.6s infinite; }
        .loader-dots div:nth-child(2) { left: 8px; animation: loader-dots2 0.6s infinite; }
        .loader-dots div:nth-child(3) { left: 32px; animation: loader-dots2 0.6s infinite; }
        .loader-dots div:nth-child(4) { left: 56px; animation: loader-dots3 0.6s infinite; }
        @keyframes loader-dots1 { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes loader-dots3 { 0% { transform: scale(1); } 100% { transform: scale(0); } }
        @keyframes loader-dots2 { 0% { transform: translate(0, 0); } 100% { transform: translate(24px, 0); } }
    </style>
</head>
<body>

<!-- App Frame -->
<div class="app-container font-sans text-slate-800">
    
    <!-- Top Bar -->
    <header class="px-6 py-5 flex justify-between items-center bg-white z-20">
        <div class="flex items-center gap-2.5">
            <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center shadow-glow text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
            </div>
            <h1 class="font-bold text-xl tracking-tight text-slate-900">Quynj</h1>
        </div>
        <button id="settingsBtn" class="text-slate-400 hover:text-primary-600 transition-colors p-1 rounded-full hover:bg-slate-50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
            </svg>
        </button>
    </header>

    <!-- Scrollable Content Area -->
    <main class="flex-1 overflow-y-auto no-scrollbar px-6 pb-6 flex flex-col gap-5">
        
        <!-- Language Switcher Pill -->
        <div class="bg-surface rounded-2xl p-1.5 flex items-center shadow-inner relative">
            <div class="flex-1 relative group">
                <select id="sourceLang" class="w-full bg-transparent appearance-none py-2 pl-4 pr-8 text-sm font-semibold text-slate-600 focus:outline-none cursor-pointer hover:text-primary-600 transition-colors z-10 relative">
                    <option value="English">English</option>
                    <option value="Chinese">中文</option>
                    <option value="Auto">Auto Detect</option>
                </select>
                <!-- Custom Arrow -->
                <div class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none group-hover:text-primary-500">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>

            <div class="text-slate-300 mx-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
            </div>

            <div class="flex-1 relative group">
                <select id="targetLang" class="w-full bg-transparent appearance-none py-2 pl-4 pr-8 text-sm font-semibold text-primary-600 focus:outline-none cursor-pointer text-right z-10 relative">
                    <option value="Chinese">中文</option>
                    <option value="English">English</option>
                    <option value="Japanese">日本語</option>
                    <option value="French">Français</option>
                </select>
                 <!-- Custom Arrow -->
                 <div class="absolute right-2 top-1/2 -translate-y-1/2 text-primary-400 pointer-events-none">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>
        </div>

        <!-- Input Area (Floating Surface) -->
        <div class="relative group">
            <textarea id="inputText" 
                class="w-full h-36 p-4 bg-white border border-slate-100 rounded-3xl shadow-soft text-slate-700 placeholder:text-slate-300 resize-none focus:outline-none focus:ring-2 focus:ring-primary-100 focus:border-primary-200 transition-all duration-300"
                placeholder="Type a word or paste a sentence..."
            ></textarea>
            <div class="absolute bottom-4 right-4 text-[10px] font-bold text-slate-300 transition-colors" id="charCount">0/1000</div>
        </div>

        <!-- Action Button -->
        <button id="translateBtn" class="w-full py-3.5 bg-gradient-to-r from-primary-600 to-primary-700 hover:to-primary-600 text-white rounded-2xl font-semibold shadow-lg shadow-primary-500/30 transform active:scale-[0.98] transition-all duration-200 flex justify-center items-center group">
            <span class="group-hover:tracking-wide transition-all duration-300">Translate</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 opacity-70 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
        </button>

        <!-- Result Area -->
        <div id="resultContainer" class="hidden flex-col gap-3 pb-4">
            <div class="flex justify-between items-center px-1 mt-2">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Result</span>
                <button id="copyBtn" class="p-1.5 rounded-lg text-slate-400 hover:text-primary-600 hover:bg-primary-50 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                </button>
            </div>
            
            <div id="resultContent" class="fade-in-up">
                <!-- Injected via JS -->
            </div>
        </div>
        
        <!-- Empty State Illustration (Hidden when active) -->
        <div id="emptyState" class="flex flex-col items-center justify-center mt-4 text-slate-300 opacity-60">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
            </svg>
            <p class="text-xs">Ready to translate</p>
        </div>

    </main>

    <!-- Settings Panel (Slide Over) -->
    <div id="settingsPanel" class="absolute inset-0 bg-white/95 backdrop-blur-md z-30 transform translate-y-full transition-transform duration-400 ease-out flex flex-col">
        <div class="px-6 py-5 flex items-center justify-between border-b border-slate-100">
            <h2 class="font-bold text-lg text-slate-800">Preferences</h2>
            <button id="closeSettings" class="p-2 rounded-full hover:bg-slate-100 text-slate-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>

        <div class="p-6 flex flex-col gap-6 overflow-y-auto no-scrollbar flex-1">
            
            <!-- API Config -->
            <div class="space-y-3">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">API Configuration(require)</label>
                <div class="space-y-3">
                    <input type="text" id="apiBaseUrl" placeholder="Full URL (e.g. .../v1/chat/completions)" class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-primary-100 placeholder-slate-400 transition-all">
                    <input type="password" id="apiKey" placeholder="API Key (sk-...)" class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-primary-100 placeholder-slate-400 transition-all">
                    <!-- New Model Input -->
                    <input type="text" id="modelName" placeholder="Model (e.g. gpt-4o)" class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-primary-100 placeholder-slate-400 transition-all">
                </div>
            </div>

            <!-- AI Config -->
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Temperature(option)</label>
                    <span id="tempValue" class="text-xs font-bold text-primary-600 bg-primary-50 px-2 py-0.5 rounded">0.3</span>
                </div>
                <div>
                    <input type="range" id="tempInput" min="0.1" max="2.0" step="0.1" value="0.3" class="w-full">
                    <div class="flex justify-between text-[10px] text-slate-400 mt-2 font-medium">
                        <span>Precise</span>
                        <span>Creative</span>
                    </div>
                </div>
            </div>

            <!-- Custom Prompt -->
            <div class="space-y-3 flex-1 flex flex-col">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">System Prompt(option)</label>
                <textarea id="systemPrompt" class="w-full flex-1 p-4 bg-slate-50 border-none rounded-xl text-sm resize-none focus:ring-2 focus:ring-primary-100 leading-relaxed text-slate-600" placeholder="Customize the AI behavior..."></textarea>
            </div>

            <button id="saveSettings" class="w-full py-3 bg-slate-800 text-white rounded-xl font-medium shadow-lg shadow-slate-300/50 active:scale-[0.98] transition-all">
                Save Changes
            </button>
        </div>
    </div>

    <!-- Alert Toast -->
    <div id="toast" class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white text-xs font-medium py-2 px-4 rounded-full shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none z-50">
        Action Successful
    </div>

</div>

<script>
    // --- Logic is refined for full URL support and custom models ---

    const DEFAULT_BASE_URL = "https://api.openai.com/v1/chat/completions";
    const DEFAULT_MODEL = "gpt-4o-mini";
    const DEFAULT_PROMPT = `You are a professional dictionary and translator assistant. 
    Analyze the user input. 
    1. If the input is a single word or a short idiomatic phrase, act as a Dictionary. Return a JSON object with a "type" of "dictionary" and a "content" array. Each item must have "pos" (e.g., n., v.) and "meaning".
    2. If the input is a sentence, act as a Translator. Return a JSON object with "type": "translation" and "content": "translated text".
    Format: {"type": "...", "content": ...}`;
    const RESPONSE_JSON_SCHEMA = {
        "type": "object",
        "properties": {
            "type": {
                "type": "string",
                "enum": ["dictionary", "translation"]
            },
            "content": {
                "oneOf": [
                    {
                        "type": "array",
                        "items": {
                            "type": "object",
                            "properties": {
                                "pos": { "type": "string" },
                                "meaning": { "type": "string" }
                            },
                            "required": ["pos", "meaning"]
                        }
                    },
                    { "type": "string" }
                ]
            }
        },
        "required": ["type", "content"]
    };


    const els = {
        settingsBtn: document.getElementById('settingsBtn'),
        settingsPanel: document.getElementById('settingsPanel'),
        closeSettings: document.getElementById('closeSettings'),
        saveSettings: document.getElementById('saveSettings'),
        apiBaseUrl: document.getElementById('apiBaseUrl'),
        apiKey: document.getElementById('apiKey'),
        modelName: document.getElementById('modelName'),
        tempInput: document.getElementById('tempInput'),
        tempValue: document.getElementById('tempValue'),
        systemPrompt: document.getElementById('systemPrompt'),
        inputText: document.getElementById('inputText'),
        translateBtn: document.getElementById('translateBtn'),
        resultContainer: document.getElementById('resultContainer'),
        resultContent: document.getElementById('resultContent'),
        emptyState: document.getElementById('emptyState'),
        copyBtn: document.getElementById('copyBtn'),
        sourceLang: document.getElementById('sourceLang'),
        targetLang: document.getElementById('targetLang'),
        charCount: document.getElementById('charCount'),
        toast: document.getElementById('toast')
    };

    let config = {
        baseUrl: localStorage.getItem('ext_baseUrl') || DEFAULT_BASE_URL,
        apiKey: localStorage.getItem('ext_apiKey') || '',
        modelName: localStorage.getItem('ext_model') || DEFAULT_MODEL,
        temperature: parseFloat(localStorage.getItem('ext_temp')) || 0.3,
        customPrompt: localStorage.getItem('ext_prompt') || ''
    };

    function init() {
        els.apiBaseUrl.value = config.baseUrl;
        els.apiKey.value = config.apiKey;
        els.modelName.value = config.modelName;
        els.tempInput.value = config.temperature;
        els.tempValue.innerText = config.temperature;
        els.systemPrompt.value = config.customPrompt;
        
        const browserLang = navigator.language || navigator.userLanguage;
        if (!['Chinese', 'English', 'Japanese', 'French'].includes(els.targetLang.value)) {
            if (browserLang.startsWith('zh')) els.targetLang.value = 'Chinese';
            else els.targetLang.value = 'English';
        }
    }

    // UI Interactions
    els.settingsBtn.addEventListener('click', () => {
        els.settingsPanel.classList.remove('translate-y-full');
    });
    
    els.closeSettings.addEventListener('click', () => {
        els.settingsPanel.classList.add('translate-y-full');
    });

    els.tempInput.addEventListener('input', (e) => {
        els.tempValue.innerText = e.target.value;
    });

    els.inputText.addEventListener('input', (e) => {
        const len = e.target.value.length;
        els.charCount.innerText = `${len}/1000`;
        if (len > 0) els.emptyState.style.display = 'none';
        else if (els.resultContainer.classList.contains('hidden')) els.emptyState.style.display = 'flex';
    });

    function showToast(msg) {
        els.toast.innerText = msg;
        els.toast.classList.remove('opacity-0');
        setTimeout(() => els.toast.classList.add('opacity-0'), 2000);
    }

    els.saveSettings.addEventListener('click', () => {
        config.baseUrl = els.apiBaseUrl.value.trim() || DEFAULT_BASE_URL;
        config.apiKey = els.apiKey.value.trim();
        config.modelName = els.modelName.value.trim() || DEFAULT_MODEL;
        config.temperature = parseFloat(els.tempInput.value);
        config.customPrompt = els.systemPrompt.value.trim();

        localStorage.setItem('ext_baseUrl', config.baseUrl);
        localStorage.setItem('ext_apiKey', config.apiKey);
        localStorage.setItem('ext_model', config.modelName);
        localStorage.setItem('ext_temp', config.temperature);
        localStorage.setItem('ext_prompt', config.customPrompt);

        els.settingsPanel.classList.add('translate-y-full');
        showToast("Settings Saved");
    });

    // Translation Logic
    els.translateBtn.addEventListener('click', async () => {
        const text = els.inputText.value.trim();
        if (!text) return;
        
        if (!config.apiKey) {
            els.settingsBtn.click();
            showToast("Please set API Key first");
            return;
        }

        setLoading(true);

        try {
            const systemContent = config.customPrompt || DEFAULT_PROMPT;
            const userContent = `Source: ${els.sourceLang.value}, Target: ${els.targetLang.value}. Text: "${text}"`;

            // Updated fetch call: uses full user-defined URL and configured model
            const response = await fetch(config.baseUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.apiKey}`
                },
                body: JSON.stringify({
                    model: config.modelName, 
                    messages: [
                        { role: "system", content: systemContent },
                        { role: "user", content: userContent }
                    ],
                    temperature: config.temperature,
                    response_format: { 
                        type: "json_schema",
                        json_schema: RESPONSE_JSON_SCHEMA
                    }
                })
            });

            if (!response.ok) throw new Error('API Error');
            
            const data = await response.json();
            const content = JSON.parse(data.choices[0].message.content);
            
            renderResult(content);
        } catch (error) {
            els.resultContent.innerHTML = `<div class="p-4 bg-red-50 text-red-500 rounded-xl text-sm border border-red-100">Error: ${error.message}</div>`;
            els.resultContainer.classList.remove('hidden');
        } finally {
            setLoading(false);
        }
    });

    function setLoading(isLoading) {
        if (isLoading) {
            els.translateBtn.disabled = true;
            els.translateBtn.innerHTML = `<div class="loader-dots relative w-16 h-4"><div class="absolute bg-white/80 w-2 h-2 rounded-full"></div><div class="absolute bg-white/80 w-2 h-2 rounded-full"></div><div class="absolute bg-white/80 w-2 h-2 rounded-full"></div><div class="absolute bg-white/80 w-2 h-2 rounded-full"></div></div>`;
            els.emptyState.style.display = 'none';
        } else {
            els.translateBtn.disabled = false;
            els.translateBtn.innerHTML = `<span class="group-hover:tracking-wide transition-all duration-300">Translate</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 opacity-70 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>`;
        }
    }

    function renderResult(data) {
        els.resultContainer.classList.remove('hidden');
        els.resultContent.innerHTML = '';
        els.emptyState.style.display = 'none';

        if (data.type === 'dictionary' && Array.isArray(data.content)) {
            // High-End Dictionary Card Layout
            const container = document.createElement('div');
            container.className = 'flex flex-col gap-3';

            data.content.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-soft border border-slate-50 flex items-start gap-3 hover:shadow-md transition-shadow duration-300';
                
                // Beautiful Badge
                const badge = document.createElement('span');
                badge.className = 'px-2.5 py-1 bg-primary-50 text-primary-600 text-xs font-bold rounded-md tracking-wide uppercase shadow-sm';
                badge.innerText = item.pos.replace('.', '');

                const text = document.createElement('p');
                text.className = 'text-slate-700 text-sm leading-relaxed pt-0.5 font-medium';
                text.innerText = item.meaning;

                card.appendChild(badge);
                card.appendChild(text);
                container.appendChild(card);
            });
            els.resultContent.appendChild(container);

        } else {
            // Clean Translation Card
            const card = document.createElement('div');
            card.className = 'bg-white p-5 rounded-2xl shadow-soft border border-slate-50 text-slate-700 leading-7 font-medium';
            card.innerText = data.content;
            els.resultContent.appendChild(card);
        }
    }

    els.copyBtn.addEventListener('click', () => {
        const text = els.resultContent.innerText;
        navigator.clipboard.writeText(text).then(() => {
            showToast("Copied to clipboard");
        });
    });

    init();

</script>
</body>
</html>
